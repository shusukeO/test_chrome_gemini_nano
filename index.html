<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemini Nano 画像解説アプリ</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      .container {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s;
      }
      .upload-area:hover {
        border-color: #4285f4;
      }
      .upload-area.dragover {
        border-color: #4285f4;
        background: #e8f0fe;
      }
      #imageInput {
        display: none;
      }
      #preview {
        max-width: 100%;
        max-height: 400px;
        margin: 20px auto;
        display: none;
        border-radius: 8px;
      }
      .prompt-section {
        margin-top: 20px;
      }
      #promptInput {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        resize: vertical;
        min-height: 60px;
      }
      button {
        background: #4285f4;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 16px;
        width: 100%;
        transition: background 0.3s;
      }
      button:hover {
        background: #3367d6;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 24px;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 8px;
        white-space: pre-wrap;
        line-height: 1.6;
        display: none;
      }
      .error {
        color: #d93025;
        background: #fce8e6;
        padding: 12px;
        border-radius: 8px;
        margin-top: 16px;
        display: none;
      }
      .loading {
        display: none;
        text-align: center;
        margin-top: 16px;
      }
      .loading::after {
        content: "";
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #4285f4;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .setup-info {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
        font-size: 14px;
      }
      .setup-info h3 {
        margin-top: 0;
        color: #856404;
      }
      .setup-info code {
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>Gemini Nano 画像解説</h1>

    <div class="setup-info">
      <h3>初回セットアップ</h3>
      <p>Chrome で以下のフラグを有効にしてください：</p>
      <ul>
        <li><code>chrome://flags/#optimization-guide-on-device-model</code></li>
        <li><code>chrome://flags/#prompt-api-for-gemini-nano</code></li>
        <li>
          <code
            >chrome://flags/#prompt-api-for-gemini-nano-multimodal-input</code
          >
        </li>
      </ul>
      <p>フラグを有効にした後、Chromeを再起動してください。</p>
    </div>

    <div class="container">
      <div class="upload-area" id="uploadArea">
        <p>クリックまたはドラッグ＆ドロップで画像をアップロード</p>
        <input type="file" id="imageInput" accept="image/*" />
      </div>

      <img id="preview" alt="プレビュー" />

      <div class="prompt-section">
        <textarea
          id="promptInput"
          placeholder="質問を入力（例：この画像に何が写っていますか？）"
        >
この画像について詳しく説明してください。</textarea
        >
      </div>

      <button id="analyzeBtn" disabled>画像を解析</button>

      <div class="loading" id="loading">解析中...</div>
      <div class="error" id="error"></div>
      <div class="result" id="result"></div>
    </div>

    <script>
      const uploadArea = document.getElementById("uploadArea");
      const imageInput = document.getElementById("imageInput");
      const preview = document.getElementById("preview");
      const promptInput = document.getElementById("promptInput");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const loading = document.getElementById("loading");
      const error = document.getElementById("error");
      const result = document.getElementById("result");

      let selectedFile = null;
      let session = null;

      // ドラッグ＆ドロップ
      uploadArea.addEventListener("click", () => imageInput.click());

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith("image/")) {
          handleFile(file);
        }
      });

      imageInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          handleFile(file);
        }
      });

      function handleFile(file) {
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          preview.src = e.target.result;
          preview.style.display = "block";
          analyzeBtn.disabled = false;
        };
        reader.readAsDataURL(file);
      }

      // Gemini Nano セッション初期化
      async function initSession() {
        // 新しいAPI形式 (self.ai.languageModel) と古い形式 (LanguageModel) の両方に対応
        const api =
          self.ai?.languageModel ||
          (typeof LanguageModel !== "undefined" ? LanguageModel : null);

        if (!api) {
          throw new Error(
            "このブラウザはGemini Nano (LanguageModel API) に対応していません。Chrome 131以降が必要です。"
          );
        }

        // availabilityでモデルの状態を確認
        if (typeof api.availability === "function") {
          const availability = await api.availability({
            expectedInputs: [
              { type: "text", languages: ["ja"] },
              { type: "image" },
            ],
            expectedOutputs: [{ type: "text", languages: ["ja"] }],
          });
          console.log("Model availability:", availability);
          if (availability === "unavailable") {
            throw new Error(
              "Gemini Nanoが利用できません。Chromeのフラグを有効にしてください。"
            );
          }
          if (availability === "downloadable") {
            console.log("モデルをダウンロード中...");
          }
        }

        session = await api.create({
          systemPrompt:
            "あなたは画像の内容を詳しく解説するアシスタントです。日本語で回答してください。",
          expectedInputs: [
            { type: "text", languages: ["ja"] },
            { type: "image" },
          ],
          expectedOutputs: [{ type: "text", languages: ["ja"] }],
        });
      }

      // 画像解析
      analyzeBtn.addEventListener("click", async () => {
        if (!selectedFile) return;

        error.style.display = "none";
        result.style.display = "none";
        loading.style.display = "block";
        analyzeBtn.disabled = true;

        try {
          if (!session) {
            await initSession();
          }

          const promptText =
            promptInput.value.trim() || "この画像について説明してください。";

          // ストリーミングで応答を取得（LanguageModelMessage形式 - 配列でラップ）
          const stream = session.promptStreaming([
            {
              role: "user",
              content: [
                { type: "text", value: promptText },
                { type: "image", value: selectedFile },
              ],
            },
          ]);

          result.textContent = "";
          result.style.display = "block";

          // チャンクを累積して表示
          let fullText = "";
          for await (const chunk of stream) {
            fullText += chunk;
            result.textContent = fullText;
          }
        } catch (err) {
          console.error(err);
          error.textContent = err.message;
          error.style.display = "block";
        } finally {
          loading.style.display = "none";
          analyzeBtn.disabled = false;
        }
      });

      // 初期チェック
      (async () => {
        const api =
          self.ai?.languageModel ||
          (typeof LanguageModel !== "undefined" ? LanguageModel : null);
        if (!api) {
          error.textContent =
            "このブラウザはGemini Nano (LanguageModel API) に対応していません。Chrome 131以降でお試しください。";
          error.style.display = "block";
        }
      })();
    </script>
  </body>
</html>
